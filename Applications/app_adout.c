#include "app_about.h"
#include "main.h"
#include "oled.h"
#include "key.h"
#include "menu_core.h"
#include "w25qxx.h"

// --- 图片数据 (仅用于烧录，烧录完可以注释掉以节省单片机Flash) ---
// const uint8_t namecardData[] = {
// 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x30, 0xb0, 0xb0, 0xb0, 0xb0, 0xb0, 0x30, 0xf0, 0x00, 0x00, 0x80, 0x00, 0x80, 0xa0, 0xc0, 0xc0, 0x00, 0x30,
// 0x70, 0x40, 0x40, 0xb0, 0x00, 0xc0, 0xc0, 0x00, 0x40, 0xc0, 0xc0, 0x80, 0xc0, 0x40, 0x40, 0x00, 0x60, 0x60, 0xe0, 0x40, 0x00, 0xe0, 0xf0, 0x30,
// 0xb0, 0xb0, 0xb0, 0xb0, 0x30, 0xf0, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xbf, 0x30, 0x37, 0xb7, 0xb7, 0xb7, 0x37,
// 0xb0, 0xbf, 0x00, 0x00, 0x7f, 0xce, 0xe8, 0xe8, 0x83, 0x66, 0x44, 0x4c, 0x7a, 0x4e, 0x44, 0xa0, 0x4c, 0x60, 0x60, 0x80, 0x7e, 0xcc, 0xc4, 0x63,
// 0xc3, 0x62, 0x62, 0x4e, 0xb8, 0x40, 0xca, 0x3e, 0x00, 0x3f, 0x3f, 0xb0, 0xb7, 0x37, 0x37, 0xb7, 0x30, 0x3f, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00,
// 0x00, 0x00, 0x00, 0x00, 0x00, 0xf3, 0x02, 0x02, 0xfd, 0xed, 0x25, 0x2d, 0xdd, 0x2d, 0xf0, 0xf0, 0x0c, 0x1d, 0x7d, 0xfd, 0xcd, 0xf0, 0x3c, 0x3c,
// 0x12, 0xbe, 0xbe, 0x85, 0x82, 0x9e, 0x9e, 0xbd, 0x92, 0xbc, 0xbc, 0x3e, 0x01, 0x32, 0x32, 0x2e, 0x25, 0x03, 0x03, 0xd2, 0x1c, 0x1c, 0x3f, 0xf3,
// 0x3f, 0x01, 0x01, 0x2f, 0xe6, 0x24, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1d, 0x88, 0x88, 0xe8, 0x00, 0x78, 0x38,
// 0x17, 0x69, 0x91, 0x91, 0xf7, 0x02, 0x02, 0x02, 0xe7, 0x63, 0x00, 0x00, 0xff, 0xff, 0x87, 0x87, 0x87, 0x07, 0x07, 0x1f, 0x1f, 0x3f, 0xff, 0xff,
// 0x00, 0x09, 0x69, 0x60, 0x92, 0x93, 0xf3, 0x68, 0x72, 0x12, 0x1f, 0x6f, 0x03, 0x01, 0x91, 0x68, 0x72, 0x60, 0xe1, 0x00, 0x00, 0x00, 0x00, 0x00,
// 0x00, 0x00, 0x00, 0x00, 0x00, 0xce, 0x71, 0x71, 0x31, 0xcf, 0x08, 0x08, 0xc9, 0x49, 0xb8, 0xb8, 0x31, 0x49, 0x01, 0x01, 0x0e, 0x00, 0x80, 0x80,
// 0x4f, 0x8f, 0x0f, 0x4f, 0x0f, 0x8f, 0x8e, 0x4e, 0x8e, 0xcf, 0xcf, 0x8f, 0x00, 0x81, 0x81, 0xbf, 0x49, 0x49, 0xc9, 0x8e, 0x4f, 0x01, 0x81, 0xb8,
// 0xb9, 0x08, 0x0c, 0xc1, 0x78, 0x38, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xcf, 0x40, 0x40, 0x47, 0x4b, 0x4f, 0x4e,
// 0x4c, 0xcb, 0x0c, 0x0c, 0xbf, 0xf8, 0xaa, 0x2a, 0x23, 0x8c, 0x6c, 0x6c, 0x4f, 0xef, 0xef, 0xfa, 0x08, 0x67, 0x67, 0x3f, 0x4c, 0x04, 0x04, 0x7b,
// 0x80, 0x04, 0x0c, 0x0b, 0x8e, 0x00, 0x20, 0xfc, 0x0e, 0x0a, 0x4b, 0x0c, 0xef, 0x24, 0xa4, 0x48, 0xc2, 0x42, 0xee, 0x00, 0x00, 0x00, 0x00, 0x00,
// 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0xce, 0xdf, 0xdf, 0xdf, 0xce, 0xc0, 0x7f, 0x00, 0x00, 0x5f, 0x1d, 0x64, 0x64, 0x24, 0x7f, 0x20, 0x20,
// 0x52, 0x04, 0x04, 0x25, 0x50, 0x02, 0x02, 0x02, 0x52, 0x66, 0x66, 0xf2, 0x73, 0x52, 0x52, 0x44, 0x3c, 0x02, 0x42, 0x03, 0x46, 0x46, 0x66, 0x02,
// 0x66, 0x64, 0x74, 0x12, 0x44, 0x40, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0,
// 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0,
// 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0,

// };
// const uint8_t qqData[] = {
// 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xe0, 0x60, 0x70, 0x30, 0x30, 0x30, 0x30, 0x70, 0xe0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0xc0, 0x40, 0xf0, 0x50,
// 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x30, 0x10, 0xf0, 0x00, 0x30, 0x10, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x50, 0xc0, 0x40, 0xf0, 0x00, 0x00, 0x00,
// 0x80, 0xc0, 0xe0, 0x70, 0x30, 0x30, 0x30, 0x30, 0x30, 0x70, 0xe0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x7f, 0xe1, 0xc0, 0x9e,
// 0xbf, 0x3f, 0x3f, 0x9f, 0x8e, 0xc0, 0xf3, 0x7f, 0x1e, 0x00, 0x00, 0x03, 0x01, 0xfc, 0x54, 0xf0, 0x50, 0x33, 0x01, 0xf3, 0x51, 0x30, 0x00, 0xc0,
// 0x00, 0xc3, 0x41, 0x03, 0x01, 0x33, 0x00, 0xf0, 0x40, 0xc0, 0x40, 0xff, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xc0, 0x80, 0x9f, 0xbf, 0x3f, 0xbf, 0x9f,
// 0x8c, 0xc0, 0xff, 0x3f, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x40, 0xf0, 0x51, 0x11, 0x13, 0xf3, 0x53, 0xc3, 0x41, 0xf1, 0x50, 0x10, 0x10,
// 0x00, 0x00, 0x03, 0x01, 0x1c, 0x14, 0x33, 0x11, 0x00, 0x00, 0xf3, 0x51, 0x00, 0x00, 0xcf, 0x00, 0xfc, 0x54, 0x03, 0x01, 0x0c, 0x00, 0xcf, 0x45,
// 0xfc, 0x10, 0x33, 0x00, 0xc0, 0x00, 0x00, 0x00, 0xc1, 0x01, 0x01, 0x03, 0xc3, 0x03, 0x31, 0x11, 0xf1, 0x40, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00,
// 0x00, 0x07, 0x05, 0x30, 0x10, 0x03, 0x01, 0xf0, 0x50, 0xc3, 0x41, 0x3f, 0x15, 0x33, 0x11, 0xfc, 0x54, 0xff, 0x55, 0x30, 0x10, 0x3f, 0x15, 0x03,
// 0xf8, 0xf8, 0xf8, 0x7b, 0x39, 0x18, 0x38, 0x78, 0xf8, 0xfb, 0xf8, 0xf0, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x3f, 0x00, 0xff, 0x45, 0xc0, 0x40, 0xcf,
// 0x01, 0x33, 0x10, 0xf0, 0x40, 0xcc, 0x44, 0xff, 0x45, 0xcf, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x05, 0x1d, 0x15, 0x1c, 0x14, 0xcf, 0x45,
// 0x11, 0x11, 0x13, 0x11, 0x13, 0x11, 0x0f, 0x05, 0x1f, 0x15, 0xc3, 0x41, 0x03, 0x01, 0x00, 0x3f, 0x7f, 0x7f, 0x78, 0x70, 0x70, 0x70, 0x78, 0x7f,
// 0x7f, 0x3f, 0x1f, 0x00, 0x03, 0x01, 0x0c, 0x00, 0x00, 0x00, 0xc0, 0x40, 0x0f, 0x05, 0xcf, 0x45, 0xff, 0x41, 0xc3, 0x11, 0x1f, 0x15, 0x3f, 0x04,
// 0xcc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x01, 0x10, 0x10, 0x34, 0x14, 0xb3, 0x91, 0x07, 0x05, 0x03, 0x01, 0x33, 0x11, 0x37, 0x15, 0x7f,
// 0x55, 0xc4, 0x44, 0x77, 0x55, 0x04, 0x04, 0x34, 0x14, 0xfc, 0x54, 0xf3, 0x00, 0x03, 0x01, 0x70, 0x50, 0x07, 0x00, 0x04, 0x04, 0xf3, 0x50, 0xf0,
// 0x00, 0x3f, 0x15, 0x3c, 0x14, 0x34, 0x10, 0xf0, 0x40, 0xc4, 0x00, 0x33, 0x00, 0x00, 0x44, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc,
// 0x0e, 0x07, 0xe3, 0xf3, 0xf3, 0xf3, 0xf3, 0xe3, 0x06, 0x3e, 0xfc, 0xe0, 0x00, 0x00, 0xcc, 0x44, 0x1d, 0x15, 0x10, 0x10, 0x01, 0x00, 0xcc, 0x44,
// 0x1d, 0x15, 0x71, 0x10, 0x1d, 0x15, 0x1c, 0x14, 0xc1, 0x00, 0xcd, 0x45, 0x11, 0x11, 0x1d, 0x10, 0x10, 0x10, 0x71, 0x50, 0xf0, 0x10, 0x1d, 0x11,
// 0x41, 0x40, 0xc0, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x07, 0x0e, 0x1c, 0x19, 0x19, 0x3b, 0x3b, 0x19, 0x18, 0x1c,
// 0x0f, 0x07, 0x00, 0x00, 0x00, 0x07, 0x05, 0x04, 0x04, 0x1f, 0x15, 0x1f, 0x01, 0x01, 0x01, 0x10, 0x10, 0x00, 0x00, 0x07, 0x05, 0x1f, 0x15, 0x11,
// 0x00, 0x01, 0x01, 0x07, 0x00, 0x00, 0x00, 0x10, 0x10, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x10, 0x10, 0x13, 0x10, 0x10, 0x05, 0x07, 0x00, 0x00,

// };

// const Image namecardImg_Flash = {60, 60, NULL}; // 数据指针为空，表示在外部Flash
// const Image qqImg_Flash = {63, 64, NULL};

// --- 地址定义 ---
// 倒数第2个扇区: 16MB - 8KB = 0x1000000 - 0x2000 = 0xFFE000
#define ABOUT_SECTOR_ADDR  0x00FFE000
#define IMG1_ADDR          (ABOUT_SECTOR_ADDR)
#define IMG2_ADDR          (ABOUT_SECTOR_ADDR + 1024) // 偏移1KB

// --- 烧录工具函数 ---
// 请在 main.c 初始化后调用一次，然后注释掉
// void About_Burn_Images(void) {
//     // 1. 擦除扇区
//     W25Q_Erase_Sector(ABOUT_SECTOR_ADDR);
    
//     // 2. 写入图片1
//     W25Q_Write_NoCheck((uint8_t*)namecardData, IMG1_ADDR, sizeof(namecardData));
    
//     // 3. 写入图片2
//     W25Q_Write_NoCheck((uint8_t*)qqData, IMG2_ADDR, sizeof(qqData));
// }

// --- App 逻辑 ---
void App_About_Loop(void) {
    static uint8_t img_index = 0; // 0:Namecard, 1:QQ
    
    // 显存缓冲区 (我们需要从Flash读出来暂存，再画到OLED)
    // 最大图片 63*64 = 504字节，OLED_GRAM 足够大，但我们需要一个临时buffer传给 OLED_DrawImage
    // 或者我们改造 OLED_DrawImage 让它支持从 Flash 地址读？
    // 简单起见，我们在栈上开一个 buffer (512字节对于 stack 有点大，改为静态)
    static uint8_t img_buf[512]; 

    // 1. 绘制
    OLED_NewFrame();
    
    uint32_t read_addr = (img_index == 0) ? IMG1_ADDR : IMG2_ADDR;
    uint8_t w = (img_index == 0) ? 60 : 63;
    uint8_t h = (img_index == 0) ? 60 : 64;
    
    // 从 Flash 读取图片数据到 RAM
    W25Q_Read(img_buf, read_addr, (w * (h/8) + ((h%8)?w:0))); // 计算字节大小
    
    // 构建临时 Image 对象
    Image temp_img;
    temp_img.w = w;
    temp_img.h = h;
    temp_img.data = img_buf;
    
    // 居中显示
    uint8_t x = (128 - w) / 2;
    uint8_t y = (64 - h) / 2;
    OLED_DrawImage(x, y, &temp_img, OLED_COLOR_NORMAL);
    
    // 底部指示器
    if (img_index == 0) {
        OLED_PrintASCIIString(0, 0, "wechat", &afont8x6, OLED_COLOR_NORMAL);
        OLED_PrintASCIIString(120, 56, ">", &afont8x6, OLED_COLOR_NORMAL);
    } else {
        OLED_PrintASCIIString(0, 0, "QQ", &afont8x6, OLED_COLOR_NORMAL);
        OLED_PrintASCIIString(2, 56, "<", &afont8x6, OLED_COLOR_NORMAL);
    }

    OLED_ShowFrame();

    // 2. 按键
    if (Key_IsSingleClick(KEY1_ID)) { // 切换
        img_index = !img_index;
    }
    if (Key_IsSingleClick(KEY3_ID)) { // 切换
        img_index = !img_index;
    }
    if (Key_IsSingleClick(KEY2_ID)) { // 退出
        Menu_SwitchToMenu();
    }
}